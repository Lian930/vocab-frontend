<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab Master v7.1 (Cloud Sync Edition)</title>
    <style>
    :root {
        /* ğŸ¨ æ·±ç‡•éº¥æ¥µç°¡é¢¨ (Darker Oatmeal / Warm Stone) */
        
        /* èƒŒæ™¯ï¼šåŠ æ·±çš„æš–ç°çŸ³è‰²ï¼Œæ›´æœ‰ä»½é‡æ„Ÿï¼Œå®Œå…¨ä¸åˆºçœ¼ */
        --bg-color: #d1cec7;           
        
        /* å¡ç‰‡ï¼šå¸¶æœ‰ç°åº¦çš„ç±³è‰²ï¼Œä¸å†æ˜¯äº®ç™½ï¼Œåƒå†ç”Ÿç´™æ¿ */
        --card-bg: #e3e1dd;            
        
        /* è¼¸å…¥æ¡†ï¼šæ¯”å¡ç‰‡ç¨æ·±ï¼Œå½¢æˆè‡ªç„¶å‡¹æ§½ */
        --input-bg: #d6d3ce;           
        
        /* æ–‡å­—ç³»çµ±ï¼šæ·±ç‚­é»‘ï¼Œä¿æŒæ¸…æ™°é–±è®€ */
        --text-main: #292524;          
        --text-sub: #57534e;           
        
        /* é‚Šæ¡†ï¼šä½¿ç”¨æ·±ä¸€é»çš„å²©çŸ³è‰² */
        --border-color: #bab8b3;       
        
        /* å“ç‰Œè‰²ï¼šç¶­æŒæ·±ç‚­é»‘ï¼Œç©©é‡ */
        --primary: #1c1917;            
        --primary-hover: #000000;
        
        /* åŠŸèƒ½è‰²ï¼šç¨å¾®èª¿æ·±ä¸€é»é»ï¼Œé©æ‡‰æ·±è‰²èƒŒæ™¯ */
        --success: #15803d;            
        --danger: #b91c1c;             
        --warning: #b45309;            
        --practice: #7e22ce;           
        
        /* â˜ï¸ é™°å½±ï¼šå› ç‚ºèƒŒæ™¯è®Šæ·±ï¼Œé™°å½±éœ€è¦åŠ é‡ä¸€é»æ‰æœƒæœ‰ç«‹é«”æ„Ÿ */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-color); 
        color: var(--text-main);
        max-width: 900px; margin: 0 auto; padding: 40px 20px; line-height: 1.7;
        -webkit-font-smoothing: antialiased; 
    }

    /* --- æŒ‰éˆ•è¨­è¨ˆ --- */
    .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 10px 22px; border-radius: 8px; font-weight: 600; font-size: 14px;
        cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; gap: 8px;
        box-shadow: var(--shadow-sm); letter-spacing: 0.5px;
    }
    .btn:active { transform: scale(0.98); }
    
    .btn-primary { background: var(--primary); color: #e3e1dd; } 
    .btn-primary:hover { background: var(--primary-hover); box-shadow: var(--shadow-md); }
    
    .btn-success { background: var(--success); color: #f0fdf4; }
    
    /* æ¬¡è¦æŒ‰éˆ• */
    .btn-secondary { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: #d6d3ce; border-color: #78716c; }
    
    .btn-danger { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
    .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }
    
    .btn-icon { padding: 0; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;}

    /* --- æ’åºå·¥å…·åˆ—æ¨£å¼ --- */
    .sort-toolbar {
        display: flex; justify-content: flex-end; align-items: center; gap: 10px;
        margin-bottom: 20px; padding: 10px;
        background: rgba(0,0,0,0.03); border-radius: 8px;
    }
    
    .sort-select {
        padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color);
        background: var(--card-bg); color: var(--text-main); font-size: 13px; font-weight: 500;
        cursor: pointer; outline: none; box-shadow: var(--shadow-sm);
        min-width: 150px;
    }
    .sort-select:hover { border-color: var(--text-sub); }
    .sort-select:focus { border-color: var(--primary); }


    /* --- è¼¸å…¥æ¡† --- */
    input, select, textarea { 
        width: 100%; padding: 14px 16px; background: var(--input-bg); 
        border: 1px solid transparent; 
        color: var(--text-main); 
        border-radius: 8px; box-sizing: border-box; font-size: 15px; 
        font-family: inherit; transition: all 0.2s;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); /* å…§é™°å½±åŠ æ·± */
    }
    input:focus, select:focus, textarea:focus { 
        outline: none; background: #fafafa; 
        border-color: #78716c; 
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05); 
    }

    /* --- å®¹å™¨å€å¡Š --- */
    .container { 
        background: var(--card-bg); padding: 40px; border-radius: 16px; 
        box-shadow: var(--shadow-md); margin-bottom: 24px; 
        border: 1px solid rgba(255,255,255,0.2); 
    }

    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 24px; padding-bottom: 16px; 
        border-bottom: 1px solid var(--border-color);
    }
    .section-header h2 { font-weight: 800; letter-spacing: -0.5px; color: var(--primary); }

    .toggle-btn { font-size: 13px; color: var(--text-sub); cursor: pointer; padding: 6px 10px; border-radius: 6px; transition: 0.2s; background: var(--bg-color); font-weight: 600;}
    .toggle-btn:hover { background: #bab8b3; color: black; }

    /* å®šç¾©ç¾¤çµ„ */
    .def-group { 
        background: #dcd9d5; 
        padding: 24px; border-radius: 12px; margin-bottom: 16px; 
        border: 1px solid var(--border-color);
    }

    /* --- å–®å­—å¡ç‰‡ --- */
    .word-card { 
        background: var(--card-bg); 
        border: 1px solid transparent; 
        padding: 0; border-radius: 16px; margin-bottom: 24px; 
        overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        box-shadow: var(--shadow-sm);
    }
    
    .word-card:hover { 
        transform: translateY(-4px); 
        box-shadow: var(--shadow-lg); 
        border-color: rgba(0,0,0,0.15); 
    }
    
    .review-highlight { border: 2px solid #b45309 !important; box-shadow: 0 10px 30px -5px rgba(180, 83, 9, 0.2); }

    .card-header { 
        background: rgba(255,255,255,0.3); 
        padding: 20px 28px; 
        display: flex; align-items: center; gap: 12px; 
        border-bottom: 1px solid var(--border-color);
    }
    .word-title { font-size: 1.8em; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
    .word-ipa { color: var(--text-sub); font-family: 'Arial Unicode MS', sans-serif; font-size: 0.95em; background: var(--bg-color); padding: 4px 10px; border-radius: 6px; font-weight: 500;}
    
    .timer-badge {
        font-size: 11px; font-weight: 700; padding: 6px 12px; border-radius: 20px;
        background: var(--bg-color); color: var(--text-sub); margin-left: auto; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .timer-due { background: var(--warning); color: white; animation: pulse 2s infinite;}
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    .card-body { padding: 24px 28px; }

    .def-row { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed var(--border-color); display: grid; grid-template-columns: 50px 1fr; gap: 16px; }
    .def-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    
    .pos-tag { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--text-sub); text-align: right; margin-top: 6px; letter-spacing: 0.5px;}
    .pos-n { color: #0369a1; } .pos-v { color: #be123c; } .pos-adj { color: #047857; } .pos-adv { color: #b45309; } .pos-phr { color: #6d28d9; }
    
    .meaning-text { font-size: 1.2em; color: var(--text-main); font-weight: 600; line-height: 1.4; }
    .sentence-text { margin-top: 8px; font-size: 1em; color: var(--text-sub); font-style: italic; border-left: 3px solid var(--border-color); padding-left: 14px; line-height: 1.6;}

    .level-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: var(--bg-color); }
    .level-bar-fill { height: 100%; transition: width 0.5s ease-out; }

    /* --- Modal è¦–çª— --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(40, 40, 40, 0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(6px); }
    .modal-content { background: var(--card-bg); width: 90%; max-width: 550px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid var(--border-color); overflow: hidden; max-height: 90vh; overflow-y: auto;}
    
    .modal-header { padding: 24px; background: rgba(255,255,255,0.3); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;}
    .modal-body { padding: 28px; }
    .modal-footer { padding: 20px 24px; background: rgba(255,255,255,0.3); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

    /* --- æ¸¬é©—é¸å–® --- */
    .quiz-option-label {
        display: flex; align-items: center; gap: 14px;
        padding: 16px 20px; margin-bottom: 12px;
        border: 1px solid var(--border-color); border-radius: 12px;
        cursor: pointer; transition: all 0.2s; text-align: left;
        background: #f5f5f4; /* æ¯”å¡ç‰‡äº®ä¸€é» */
        box-shadow: var(--shadow-sm);
    }
    .quiz-option-label:hover { border-color: var(--text-main); background: #ffffff; transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .quiz-option-label input[type="checkbox"] { width: 20px; height: 20px; margin: 0; cursor: pointer; accent-color: var(--text-main); }

    #notification-area { background: #fef3c7; border: 1px solid #d97706; color: #92400e; padding: 16px; border-radius: 12px; margin-bottom: 24px; display: none; box-shadow: var(--shadow-sm); }
    
    .big-speaker-btn { background: var(--text-main); color: #e3e1dd; border: none; border-radius: 50%; width: 100px; height: 100px; font-size: 44px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 30px auto; box-shadow: 0 10px 25px rgba(0,0,0, 0.2); transition: transform 0.2s; }
    .big-speaker-btn:active { transform: scale(0.95); }

    /* --- å´é‚Šæ‡¸æµ®å·¥å…·ç®± (Responsive Sidebar) --- */
    /* é è¨­ (æ‰‹æ©Ÿ/å¹³æ¿)ï¼šä¿æŒåŸæœ¬çš„æ©«å‘æ’åˆ— */
    .sort-toolbar {
        display: flex; justify-content: flex-end; align-items: center; gap: 10px;
        margin-bottom: 20px; padding: 10px;
        background: rgba(0,0,0,0.03); border-radius: 8px;
    }

    /* ğŸ–¥ï¸ é›»è…¦ç‰ˆï¼šè®Šèº«ç‚ºå³å´æ‡¸æµ®é¢æ¿ */
    @media (min-width: 1250px) {
        .sort-toolbar {
            position: fixed;
            top: 150px;           /* è·é›¢é ‚éƒ¨çš„é«˜åº¦ */
            left: 50%;            /* å¾è¢å¹•æ­£ä¸­é–“é–‹å§‹ç®— */
            margin-left: 470px;   /* å¾€å³æ¨ 470px (ä¸»å…§å®¹ 900px/2 = 450 + 20px é–“è·) */
            
            width: 220px;         /* å´é‚Šæ¬„å¯¬åº¦ */
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
            align-items: stretch; 
            
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            padding: 24px;
            border-radius: 16px;
            z-index: 100;         /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
            gap: 15px;
        }

        /* åŠ ä¸€å€‹å¸¥æ°£çš„æ¨™é¡Œ */
        .sort-toolbar::before {
            content: "ğŸ”§ å·¥å…·ç®±";
            font-size: 1.1em;
            font-weight: 800;
            color: var(--primary);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 5px;
            display: block;
        }

        /* éš±è—åŸæœ¬çš„ "æ’åºæ–¹å¼ï¼š" æ–‡å­—ï¼Œå› ç‚ºæœ‰æ¨™é¡Œäº† */
        .sort-toolbar label { display: none; }
        
        /* è®“ä¸‹æ‹‰é¸å–®å’ŒæŒ‰éˆ•ä½”æ»¿å¯¬åº¦ */
        .sort-select, .sort-toolbar .btn {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid transparent;
        }
        .sort-select:hover { background: white; border-color: var(--border-color); }
    }

</style>
</head>
<body>

    <div id="notification-area"></div>

    <div class="container">
        <div class="section-header" style="margin-bottom:0; border-bottom:none;">
            <h2 style="margin:0; border:none; padding:0;">ğŸ“š æ–°å¢å–®å­—</h2>
            <span class="toggle-btn" onclick="toggleSection('add-section')">â–¼ å±•é–‹/æ”¶åˆ</span>
        </div>
        
        <div id="add-section" style="display:none; margin-top:20px; border-top: 2px solid var(--primary); padding-top:20px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:15px;">
                
                <div>
                    <label style="font-size:12px; color:var(--primary); font-weight:bold;">è‹±æ–‡å–®å­— *</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="input-word" placeholder="ä¾‹: algorithm" style="font-size:1.2em; font-weight:bold;">
                        <button id="ai-fetch-btn" onclick="fetchWordData()" class="btn btn-primary" style="white-space:nowrap;">âœ¨ AI æŠ“å–</button>
                    </div>
                </div>
                <div><label style="font-size:12px; color:var(--text-sub);">éŸ³æ¨™ (é¸å¡«)</label><input type="text" id="input-ipa" placeholder="ä¾‹: [rÉªËˆmoÊŠt]"></div>
            </div>
            <div id="definitions-container"></div>
            <button onclick="addDefinitionInput('definitions-container')" class="btn btn-secondary" style="width:100%; border-style:dashed; margin-top:10px;">+ æ–°å¢å®šç¾©</button>
            <div style="margin-top:20px; display:flex; justify-content:flex-end;">
                <button type="button" onclick="clearAddForm()" class="btn btn-secondary" style="padding:10px 20px;">ğŸ§¹ æ¸…ç©ºæ¬„ä½</button>
                <button id="save-new-btn" onclick="saveNewCard()" class="btn btn-primary" style="padding:10px 30px;">å„²å­˜å–®å­—å¡</button>
            </div>
        </div>
    </div>

    <div class="container" style="background:transparent; border:none; box-shadow:none; padding:0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; border:none; color:var(--text-main);">ğŸ—‚ï¸ é›²ç«¯å­—åº« (<span id="total-count" style="color:var(--primary);">0</span>)</h2>
            </div>

        <div class="sort-toolbar">
            <button onclick="startQuiz('practice')" class="btn btn-success" style="font-size:13px; justify-content:center;">ğŸ² éš¨æ©Ÿåˆ·é¡Œ</button>
            
            <label style="font-size:13px; color:var(--text-sub); font-weight:600;">æ’åºæ–¹å¼ï¼š</label>
            <select id="sort-mode" class="sort-select" onchange="renderCards()">
                <option value="review-asc">â³ è¤‡ç¿’æ™‚é–“ (ç”±è¿‘åˆ°é )</option>
                <option value="review-desc">ğŸ“… è¤‡ç¿’æ™‚é–“ (ç”±é åˆ°è¿‘)</option>
                <option value="level-asc">ğŸŒ± ç­‰ç´š (ç”±ä½åˆ°é«˜)</option>
                <option value="level-desc">ğŸŒ³ ç­‰ç´š (ç”±é«˜åˆ°ä½)</option>
                <option value="alpha-asc">ğŸ”¤ å­—æ¯é †åº (A-Z)</option>
                <option value="alpha-desc">ğŸ”¤ å­—æ¯é †åº (Z-A)</option>
            </select>
        </div>
        
        <div id="card-list"></div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0;">âœ ç·¨è¼¯å–®å­—</h3><span onclick="closeEditModal()" style="cursor:pointer; font-size:20px;">&times;</span></div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:15px;">
                    <div><label style="font-size:12px; color:var(--primary);">è‹±æ–‡å–®å­—</label><input type="text" id="edit-word"></div>
                    <div><label style="font-size:12px; color:var(--text-sub);">éŸ³æ¨™</label><input type="text" id="edit-ipa"></div>
                </div>
                <label style="font-size:12px; color:var(--text-sub);">å®šç¾©åˆ—è¡¨</label>
                <div id="edit-defs-container"></div>
                <button onclick="addDefinitionInput('edit-defs-container')" class="btn btn-secondary" style="width:100%; border-style:dashed; margin-top:10px;">+ æ–°å¢å®šç¾©</button>
            </div>
            <div class="modal-footer">
                <button onclick="deleteCardFromEdit()" class="btn btn-danger" style="margin-right:auto;">åˆªé™¤æ­¤å­—</button>
                <button onclick="closeEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button id="save-edit-btn" onclick="saveEditCard()" class="btn btn-primary">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:500px; text-align: center;">
            
            <div class="modal-header" style="justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-color);">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3 id="quiz-title" style="color:var(--primary); margin:0;">æ¸¬é©—è¨­å®š</h3>
                    <span id="quiz-mode-badge" style="font-size:10px; padding:2px 6px; border-radius:4px;"></span>
                </div>
                <div id="quiz-status" style="display:none; font-size:14px; font-variant-numeric: tabular-nums;">
                    <span id="quiz-timer" style="color:var(--warning); margin-right:10px;">00:00</span>
                    <span id="quiz-counter" style="background:#334155; padding:2px 8px; border-radius:12px; font-size:12px;">0/0</span>
                </div>
            </div>

            <div class="modal-body" id="quiz-body">
                </div>

            <div id="quiz-feedback" style="min-height:30px; margin:10px; font-weight:bold;"></div>

            <div class="modal-footer" id="quiz-footer" style="justify-content:center; border:none; padding-top:0;">
                <button onclick="closeQuiz()" class="btn btn-secondary" style="width:100%;">é—œé–‰ / æ”¾æ£„</button>
            </div>
        </div>
    </div>

<script>
    // --- API åŸºæœ¬è¨­å®š (é›²ç«¯ç‰ˆ) ---
    const API_BASE_URL = 'https://vocab-backend-api.onrender.com/api/words';
    
    let cards = []; 
    let reviewList = []; 
    let quizQueue = [];
    let currentQ = null;
    let currentMode = ''; 

    // --- åˆå§‹åŒ– ---
    window.onload = async function() {
        addDefinitionInput('definitions-container');
        await loadWordsFromAPI(); 
        setInterval(checkReview, 60000); 
    };

    function updateCount() { document.getElementById('total-count').innerText = cards.length; }
    function toggleSection(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'none') ? 'block' : 'none'; }
    function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); }

    // --- è¼”åŠ©å‡½å¼ï¼šå–å¾—ä»Šå¤©çš„åˆå¤œæ™‚é–“æˆ³è¨˜ (00:00:00) ---
    function getTodayMidnight() {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        return now.getTime();
    }
    // --- é›²ç«¯è³‡æ–™æ“ä½œ (CRUD) ---
    // --- å‡ç´šç‰ˆï¼šSWR é›™é‡è¼‰å…¥æ©Ÿåˆ¶ (LocalStorage + é›²ç«¯åŒæ­¥) ---
    // --- é›²ç«¯è³‡æ–™æ“ä½œ (CRUD) ---
    // --- é›²ç«¯è³‡æ–™æ“ä½œ (CRUD) ---
    async function loadWordsFromAPI() {
        const loadingIndicator = document.getElementById('loading-indicator'); 
        if (loadingIndicator) loadingIndicator.style.display = 'block';

        // ğŸ› ï¸ æŠ½é›¢å‡ºä¾†çš„ã€Œè³‡æ–™ä¿®å¾©ä¸­å¿ƒã€ï¼šä¸ç®¡è³‡æ–™å¾å“ªä¾†ï¼Œéƒ½å…ˆæ´—ä¹¾æ·¨
        const cleanData = (dataList) => {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            return dataList.map(c => {
                let safeReview = c.nextReview || now;
                
                // ğŸ›‘ å¼·åŠ›ä¿®æ­£ï¼šå¦‚æœæ˜¯ Level 0 æˆ– 1 (æˆ–æ ¹æœ¬æ²’ç­‰ç´š)ï¼Œä¸”æ™‚é–“è·‘åˆ°æ˜å¤©ä»¥å¾Œ
                // å¼·åˆ¶æŠŠå®ƒæ‹‰å›ã€Œç¾åœ¨ã€ï¼Œç›´æ¥æ‰“ç ´ 29D æˆ– 27M çš„è¿´åœˆ
                if ((c.level === undefined || c.level <= 1) && (safeReview - now > oneDay)) {
                    console.warn(`è‡ªå‹•ä¿®å¾©å–®å­—æ™‚é–“ç•°å¸¸: ${c.word}`);
                    safeReview = now; 
                }
                
                return { ...c, nextReview: safeReview };
            });
        };

        // ğŸŒŸ æ­¥é©Ÿä¸€ï¼šå…ˆå¾ç€è¦½å™¨ LocalStorage æŒ–å‡ºæ­·å²å‚™ä»½
        const cachedData = localStorage.getItem('vocab_cache_data');
        if (cachedData) {
            try {
                let parsedCache = JSON.parse(cachedData);
                // å¿«å–æ‹¿å‡ºä¾†çš„è³‡æ–™ä¹Ÿè¦æ´—éï¼é¿å…ä¸€é–‹ç¶²é å…ˆçœ‹åˆ°éŒ¯èª¤æ™‚é–“
                cards = cleanData(parsedCache); 
                checkReview(); 
                updateCount(); 
                renderCards(); // ç¢ºä¿ä¸€é–‹å§‹è¼‰å…¥å¿«å–å°±æœ‰å¥—ç”¨æ’åº
                console.log("âš¡ ç¬é–“è¼‰å…¥æœ¬æ©Ÿå¿«å–ï¼");
            } catch (e) {
                console.error("å¿«å–è§£æå¤±æ•—ï¼Œå¿½ç•¥å¿«å–", e);
            }
        }

        // â˜ï¸ æ­¥é©ŸäºŒï¼šèƒŒæ™¯é»˜é»˜å‘ Render é›²ç«¯ä¼ºæœå™¨è«‹æ±‚æœ€æ–°è³‡æ–™
        try {
            const response = await fetch(API_BASE_URL);
            if (response.ok) {
                const freshCards = await response.json();
                
                // ğŸ›‘ æŠŠå¾ä¼ºæœå™¨æŠ“ä¸‹ä¾†çš„è³‡æ–™ä¹Ÿæ´—ä¹¾æ·¨ ğŸ›‘
                cards = cleanData(freshCards);
                
                // å°‡ä¿®å¾©å¾Œçš„ä¹¾æ·¨è³‡æ–™è½‰ç‚ºå­—ä¸²
                const cleanDataString = JSON.stringify(cards);
                
                // å¦‚æœæ´—ä¹¾æ·¨çš„é›²ç«¯è³‡æ–™è·Ÿå¿«å–ã€Œä¸ä¸€æ¨£ã€ï¼Œæ‰é‡æ–°æ¸²æŸ“ç•«é¢ä¸¦æ›´æ–°å¿«å–
                if (cleanDataString !== cachedData) {
                    checkReview();
                    updateCount();
                    renderCards(); // ç¢ºä¿æ’åºé‚è¼¯è¢«å¥—ç”¨
                    localStorage.setItem('vocab_cache_data', cleanDataString);
                    console.log("â˜ï¸ é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆ (å«è‡ªå‹•ä¿®å¾©)ï¼");
                } else {
                    console.log("âœ… è³‡æ–™ä¸€è‡´ï¼Œç„¡éœ€æ›´æ–°ã€‚");
                }
            } else {
                console.error("è®€å–é›²ç«¯è³‡æ–™å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š", response.status);
            }
        } catch (error) {
            console.error("ç„¡æ³•é€£ç·šåˆ°é›²ç«¯ä¼ºæœå™¨ï¼Œç¹¼çºŒä½¿ç”¨é›¢ç·šå¿«å–", error);
        } finally {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

// --- æ–°å¢ï¼šå‘¼å«å¾Œç«¯ AI æŠ“å–å–®å­—è³‡æ–™ ---
    async function fetchWordData() {
        const wordInput = document.getElementById('input-word').value.trim();
        if (!wordInput) {
            alert("è«‹å…ˆè¼¸å…¥è¦æŸ¥è©¢çš„è‹±æ–‡å–®å­—å–”ï¼");
            return;
        }

        const fetchBtn = document.getElementById('ai-fetch-btn');
        fetchBtn.disabled = true;
        fetchBtn.innerText = "â³ å‘¼å« AI...";

        try {
            // æ‰“çµ¦æœ¬æ©Ÿçš„ FastAPI è·¯ç”±å»å• AI
            const response = await fetch(`https://vocab-backend-api.onrender.com/api/fetch_word/${wordInput}`);
            
            if (response.ok) {
                const data = await response.json();
                
                // 1. è‡ªå‹•å¡«å…¥éŸ³æ¨™ (å¦‚æœæœ‰çš„è©±)
                document.getElementById('input-ipa').value = data.ipa || '';
                
                // 2. æ¸…ç©ºåŸæœ¬çš„å®šç¾©æ ¼å­ï¼Œä¸¦æ ¹æ“š AI çš„çµæœè‡ªå‹•ç”Ÿå‡ºæ–°çš„æ ¼å­
                const container = document.getElementById('definitions-container');
                container.innerHTML = ''; 
                
                if (data.definitions && data.definitions.length > 0) {
                    data.definitions.forEach(def => {
                        addDefinitionInput('definitions-container', def);
                    });
                } else {
                    addDefinitionInput('definitions-container'); 
                }
                
            } else {
                alert("æŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API é‡‘é‘°æˆ–ä¼ºæœå™¨ç‹€æ…‹ã€‚");
            }
        } catch (error) {
            console.error("AI é€£ç·šéŒ¯èª¤:", error);
            alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨æŠ“å–è³‡æ–™ã€‚");
        } finally {
            // ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦æŠŠæŒ‰éˆ•æ¢å¾©åŸç‹€
            fetchBtn.disabled = false;
            fetchBtn.innerText = "âœ¨ AI æŠ“å–";
        }
    }

    async function saveNewCard() {
        const word = document.getElementById('input-word').value.trim();
        const ipa = document.getElementById('input-ipa').value.trim();
        const defGroups = document.querySelectorAll('#definitions-container .def-group');
        let definitions = [];
        
        defGroups.forEach(group => {
            const expEl = group.querySelector('.input-explanation'); 
            
            definitions.push({
                pos: group.querySelector('.input-pos').value,
                meaning: group.querySelector('.input-meaning').value.trim(),
                explanation: expEl ? expEl.value.trim() : "", 
                sentence: group.querySelector('.input-sentence').value.trim()
            });
        });
        
        definitions = definitions.filter(d => d.meaning);
        
        if (!word || definitions.length === 0) { alert('è«‹è¼¸å…¥å–®å­—èˆ‡è‡³å°‘ä¸€å€‹è§£é‡‹ï¼'); return; }
        
        const cardData = {
            word: word,
            ipa: ipa,
            definitions: definitions,
            dateAdded: new Date().toISOString().split('T')[0],
            level: 0,
            // æ–°å¢æ™‚ç¶­æŒ Date.now()ï¼Œç¢ºä¿ä½ å¯ä»¥ã€Œç«‹åˆ»ã€åœ¨ Review åˆ—è¡¨çœ‹åˆ°å®ƒä¸¦é–‹å§‹å­¸ç¿’
            // ç¬¬ä¸€æ¬¡è¤‡ç¿’å¾Œï¼Œæ™‚é–“å°±æœƒè¢« checkAns è‡ªå‹•æ ¡æ­£å›åˆå¤œåŸºæº–
            nextReview: Date.now() 
        };

        const saveBtn = document.getElementById('save-new-btn');
        saveBtn.disabled = true; saveBtn.innerText = "å„²å­˜ä¸­...";

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cardData)
            });

            if (response.ok) {
                if (typeof clearAddForm === "function") {
                    clearAddForm();
                }
                await loadWordsFromAPI(); 
            } else {
                const err = await response.json();
                alert(`å„²å­˜å¤±æ•—ï¼š${err.detail}`); 
            }
        } catch (error) {
            console.error(error); alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼");
        } finally {
            saveBtn.disabled = false; saveBtn.innerText = "å„²å­˜å–®å­—å¡";
        }
    }

    async function saveEditCard() {
        const id = document.getElementById('edit-id').value;
        const word = document.getElementById('edit-word').value.trim();
        const ipa = document.getElementById('edit-ipa').value.trim();
        const defGroups = document.querySelectorAll('#edit-defs-container .def-group');
        let definitions = [];
        // âœ¨ æ–°å¢çš„ï¼šæŠŠ explanation ä¸€èµ·æ‰“åŒ…å­˜æª”
        defGroups.forEach(group => {
            const m = group.querySelector('.input-meaning').value.trim();
            const expEl = group.querySelector('.input-explanation'); // æŠ“å–è©³ç´°è§£é‡‹
            
            if(m) { 
                definitions.push({ 
                    pos: group.querySelector('.input-pos').value, 
                    meaning: m, 
                    explanation: expEl ? expEl.value.trim() : "", // å­˜é€²ç‰©ä»¶è£¡
                    sentence: group.querySelector('.input-sentence').value.trim() 
                }); 
            }
        });
        
        if (!word || definitions.length === 0) { alert('è³‡æ–™ä¸å®Œæ•´'); return; }

        const originalCard = cards.find(c => String(c.id) === String(id));
        if(!originalCard) { alert('æ‰¾ä¸åˆ°åŸå§‹å¡ç‰‡è³‡æ–™'); return; }
        
        const updateData = {
            id: id, word: word, ipa: ipa, definitions: definitions,
            dateAdded: originalCard.dateAdded, level: originalCard.level, nextReview: originalCard.nextReview
        };

        const saveBtn = document.getElementById('save-edit-btn');
        saveBtn.disabled = true; saveBtn.innerText = "ä¿®æ”¹ä¸­...";

        try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                closeEditModal();
                await loadWordsFromAPI(); 
            } else {
                alert("ä¿®æ”¹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨");
            }
        } catch (error) {
            console.error(error); alert("é€£ç·šéŒ¯èª¤");
        } finally {
            saveBtn.disabled = false; saveBtn.innerText = "å„²å­˜ä¿®æ”¹";
        }
    }

    async function deleteCardFromEdit() {
        const id = document.getElementById('edit-id').value;
        if(confirm('ç¢ºå®šè¦æŠŠé€™å¼µå–®å­—å¡å¾¹åº•åˆªé™¤å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸå–”ï¼')) { 
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    closeEditModal();
                    await loadWordsFromAPI(); 
                } else {
                    alert("åˆªé™¤å¤±æ•—");
                }
            } catch (error) {
                console.error(error); alert("é€£ç·šéŒ¯èª¤");
            }
        }
    }

    function addDefinitionInput(containerId, data = null) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'def-group';
        
        // æŠ“å–è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å°±çµ¦ç©ºå­—ä¸²
        const pos = data ? data.pos : 'n.';
        const meaning = data ? data.meaning : '';
        const explanation = data && data.explanation ? data.explanation : ''; 
        const sentence = data ? data.sentence : '';
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="font-size:12px; color:var(--text-sub);">å®šç¾©è¨­å®š</span>
                <span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer; color:var(--danger); font-size:12px;">âœ• ç§»é™¤</span>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:8px;">
                <div style="display:flex; gap:10px;">
                    <select class="input-pos" style="flex:1;">
                        <option value="n." ${pos==='n.'?'selected':''}>n. åè©</option>
                        <option value="v." ${pos==='v.'?'selected':''}>v. å‹•è©</option>
                        <option value="adj." ${pos==='adj.'?'selected':''}>adj. å½¢å®¹è©</option>
                        <option value="adv." ${pos==='adv.'?'selected':''}>adv. å‰¯è©</option>
                        <option value="prep." ${pos==='prep.'?'selected':''}>prep. ä»‹ç³»è©</option>
                        <option value="phr." ${pos==='phr.'?'selected':''}>phr. ç‰‡èª</option>
                        <option value="other" ${pos==='other'?'selected':''}>å…¶ä»–</option>
                    </select>
                    <input type="text" class="input-meaning" placeholder="ä¸­æ–‡ç¿»è­¯ (ä¾‹: æ¼”ç®—æ³•)" value="${meaning}" style="flex:3;">
                </div>
                <textarea class="input-explanation" rows="2" placeholder="è©³ç´°è§£é‡‹èˆ‡é©ç•¶å ´åˆ (é¸å¡«)">${explanation}</textarea>
            </div>
            
            <textarea class="input-sentence" rows="2" placeholder="ä¾‹å¥ (é¸å¡«)">${sentence}</textarea>
        `;
        container.appendChild(div);
    }

    function openEditModal(id) {
        // ä½¿ç”¨ String(c.id) ç¢ºä¿å³ä½¿ Python å›å‚³çš„ id å‹æ…‹ä¸åŒä¹Ÿèƒ½æ‰¾åˆ°
        const card = cards.find(c => String(c.id) === String(id)); 
        if (!card) return;
        document.getElementById('edit-id').value = card.id; 
        document.getElementById('edit-word').value = card.word; 
        document.getElementById('edit-ipa').value = card.ipa;
        const container = document.getElementById('edit-defs-container'); 
        container.innerHTML = '';
        card.definitions.forEach(def => { addDefinitionInput('edit-defs-container', def); });
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }

    function getLevelColor(level) {
        const hue = Math.min(level, 9) * 13; 
        return `hsl(${hue}, 80%, 60%)`; 
    }
    // --- æ™‚é–“é¡¯ç¤ºå„ªåŒ–ï¼šå¼·åˆ¶ä»¥ã€Œå¤©ã€ç‚ºå–®ä½ ---
    // --- æ™‚é–“é¡¯ç¤ºä¿®æ­£ï¼šå¼·åˆ¶ä»¥ã€Œå¤©ã€ç‚ºå–®ä½ (ç„¡æ¢ä»¶é€²ä½) ---
    function getTimeUntil(timestamp) {
        const diff = timestamp - Date.now();
        
        // å¦‚æœæ™‚é–“å·²éï¼Œé¡¯ç¤º Review Now!
        if (diff <= 0) return "Review Now!";

        // ğŸŸ¢ é—œéµä¿®æ”¹ï¼š
        // èˆŠçš„ç¨‹å¼ç¢¼æœ‰ç®—å‡º minutes å’Œ hoursï¼Œé€™è£¡æˆ‘å€‘å…¨éƒ¨æ‹¿æ‰ã€‚
        // ç›´æ¥ç®—å‡ºå¤©æ•¸ï¼Œä¸¦ç”¨ Math.ceil (ç„¡æ¢ä»¶é€²ä½)ã€‚
        // é€™æ¨£å°±ç®—æ˜¯å‰© 1 åˆ†é˜ï¼Œä¹Ÿæœƒé¡¯ç¤º "in 1d" (ä»£è¡¨åœ¨ 1 å¤©å…§åˆ°æœŸ)ï¼Œä¸æœƒé¡¯ç¤º "27M"ã€‚
        const days = Math.ceil(diff / (24 * 60 * 60 * 1000));
        
        return `in ${days}d`;
    }

    // --- æ¸²æŸ“å¡ç‰‡ (å«æ’åºé‚è¼¯) ---
    function renderCards() {
        const list = document.getElementById('card-list');
        list.innerHTML = '';
        
        // å–å¾—ç›®å‰çš„æ’åºæ¨¡å¼ï¼Œå¦‚æœæ²’æœ‰é¸å–®é è¨­ç‚º 'review-asc'
        const sortSelect = document.getElementById('sort-mode');
        const sortMode = sortSelect ? sortSelect.value : 'review-asc';
        
        // è¤‡è£½ä¸€ä»½é™£åˆ—ä¾†æ’åºï¼Œä»¥å…å½±éŸ¿åŸå§‹è³‡æ–™é †åº
        const sortedCards = [...cards].sort((a, b) => {
            // æ’åºç­–ç•¥ï¼š
            switch (sortMode) {
                case 'review-asc': // è¤‡ç¿’æ™‚é–“ (ç”±è¿‘åˆ°é ) - é€™æ˜¯é è¨­ SRS é‚è¼¯
                    return a.nextReview - b.nextReview;
                
                case 'review-desc': // è¤‡ç¿’æ™‚é–“ (ç”±é åˆ°è¿‘)
                    return b.nextReview - a.nextReview;

                case 'level-asc': // ç­‰ç´š (ç”±ä½åˆ°é«˜)
                    if (a.level !== b.level) return a.level - b.level;
                    return a.nextReview - b.nextReview; // ç­‰ç´šä¸€æ¨£æ¯”æ™‚é–“
                
                case 'level-desc': // ç­‰ç´š (ç”±é«˜åˆ°ä½)
                    if (a.level !== b.level) return b.level - a.level;
                    return a.nextReview - b.nextReview;

                case 'alpha-asc': // å­—æ¯é †åº (A-Z)
                    return a.word.localeCompare(b.word);
                
                case 'alpha-desc': // å­—æ¯é †åº (Z-A)
                    return b.word.localeCompare(a.word);
                    
                default:
                    // é è¨­ fallbackï¼šå…ˆæ¯”æ˜¯å¦åˆ°æœŸï¼Œå†æ¯” ID (æ–°èˆŠ)
                    const now = Date.now();
                    const aDue = now >= a.nextReview;
                    const bDue = now >= b.nextReview;
                    if (aDue && !bDue) return -1;
                    if (!aDue && bDue) return 1;
                    return b.id - a.id;
            }
        });

        sortedCards.forEach(card => {
            const el = document.createElement('div');
            const isDue = Date.now() >= card.nextReview;
            el.className = `word-card ${isDue ? 'review-highlight' : ''}`;
            
            const progressPercent = Math.min((card.level / 9) * 100, 100);
            const levelColor = getLevelColor(card.level);
            const timeText = getTimeUntil(card.nextReview);

            let defsHtml = '';
            card.definitions.forEach(def => {
                const posClass = `pos-${def.pos.replace('.','')}`;
                defsHtml += `
                    <div class="def-row">
                        <div class="pos-tag ${posClass}">${def.pos}</div>
                        <div class="def-content">
                            <div class="meaning-text">${def.meaning}</div>
                            ${def.explanation ? `<div style="font-size:0.95em; color:var(--text-sub); margin-top:6px; line-height:1.5;">${def.explanation}</div>` : ''}
                            ${def.sentence ? `<div class="sentence-text">${def.sentence}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            // å°‡ onClick è£¡çš„ card.id åŒ…ä¸Šå¼•è™Ÿï¼Œé˜²æ­¢å­—ä¸² ID é€ æˆèªæ³•éŒ¯èª¤
            el.innerHTML = `
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <span class="word-title">${card.word}</span>
                        <span class="word-ipa">${card.ipa}</span>
                    </div>
                    <span class="timer-badge ${isDue ? 'timer-due' : ''}">${timeText}</span>
                    <div style="display:flex; align-items:center; gap:10px; margin-left:10px;">
                        <span class="level-badge" style="color:${levelColor}; border-color:${levelColor}">Lv.${card.level}</span>
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-secondary btn-icon" onclick="speak('${card.word}')">ğŸ”Š</button>
                            <button class="btn btn-primary btn-icon" onclick="openEditModal('${card.id}')">âœ</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    ${defsHtml}
                </div>
                <div class="level-bar-container">
                    <div class="level-bar-fill" style="width:${progressPercent}%; background-color:${levelColor};"></div>
                </div>
            `;
            list.appendChild(el);
        });
    }

    // --- SRS æ¼”ç®—æ³• ---
    function checkReview() {
        const now = Date.now();
        reviewList = cards.filter(c => now >= c.nextReview);
        renderCards(); 
        const area = document.getElementById('notification-area');
        if (reviewList.length > 0) {
            area.style.display = 'block';
            area.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ”” <strong>SRS ç³»çµ±æé†’ï¼š</strong> ä»Šå¤©æœ‰ ${reviewList.length} å€‹å–®å­—åˆ°æœŸäº†ï¼</span>
                    <button class="btn btn-primary" style="background:#f59e0b; color:black;" onclick="startQuiz('review')">é–‹å§‹è¤‡ç¿’ (è¨ˆåˆ†)</button>
                </div>
            `;
        } else {
            area.style.display = 'none';
        }
    }

    // --- ä¿®æ­£å¾Œçš„ SRS é–“éš”è¨ˆç®— ---
    function calculateNextInterval(level) {
        const oneDay = 24 * 60 * 60 * 1000;
        
        // ğŸ›‘ é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯ Level 0 æˆ– Level 1ï¼Œä¸€å¾‹è¨­ç‚º 1 å¤©å¾Œè¤‡ç¿’
        // é€™æ¨£å°±ä¸æœƒç™¼ç”Ÿ Level 0 è·‘åˆ° default (30å¤©) çš„å•é¡Œ
        if (level <= 1) {
            return 1 * oneDay;
        }

        switch(level) {
            case 2: return 2 * oneDay;  
            case 3: return 7 * oneDay;  
            case 4: return 15 * oneDay; 
            default: return 30 * oneDay; 
        }
    }

    // --- ğŸ† æ¸¬é©—ç³»çµ± 2.0 (è¨­å®šã€è¨ˆæ™‚ã€é€²åº¦ã€ç¯©é¸ã€é™ç´šæ‡²ç½°) ---
    
    let quizTimerInterval = null;
    let quizStartTime = 0;
    let quizTotalCount = 0;
    let selectedTypes = [0, 1, 2, 3, 4]; // é è¨­å…¨é¸

    // --- æ¸¬é©—ç³»çµ± ---
    function startQuiz(mode) {
        currentMode = mode;
        const badgeEl = document.getElementById('quiz-mode-badge');
        const statusEl = document.getElementById('quiz-status');
        const bodyEl = document.getElementById('quiz-body');
        const footerEl = document.getElementById('quiz-footer');
        
        statusEl.style.display = 'none'; // è¨­å®šéšæ®µå…ˆéš±è—è¨ˆæ™‚å™¨
        document.getElementById('quiz-feedback').innerHTML = '';
        document.getElementById('quiz-title').innerText = "æ¸¬é©—è¨­å®š";

        // æº–å‚™é¡Œç›®åˆ—éšŠ
        if (mode === 'review') {
            quizQueue = cards.filter(c => Date.now() >= c.nextReview);
            if (quizQueue.length === 0) { alert('å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å–®å­—ã€‚'); return; }
            badgeEl.innerText = 'ğŸ”¥ SRS è¨ˆåˆ†';
            badgeEl.style.background = 'var(--warning)'; badgeEl.style.color = 'white';
        } else {
            quizQueue = [...cards].sort(() => Math.random() - 0.5).slice(0, 20);
            if (quizQueue.length === 0) { alert('å–®å­—åº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆæ–°å¢å–®å­—ï¼'); return; }
            badgeEl.innerText = 'ğŸ² éš¨æ©Ÿç·´ç¿’';
            badgeEl.style.background = 'var(--practice)'; badgeEl.style.color = 'white';
        }

        quizTotalCount = quizQueue.length;
        document.getElementById('quiz-modal').style.display = 'flex';

        // ğŸŸ¢ ä»‹é¢æ›´æ–°ï¼šä½¿ç”¨ .quiz-option-label é…åˆæ–°çš„ CSS æ’ç‰ˆ
        bodyEl.innerHTML = `
            <div style="text-align:left; padding:0 10px;">
                <p style="color:var(--text-sub); margin-bottom:15px; text-align:center;">
                    æœ¬æ¬¡å…±æœ‰ <strong style="color:var(--text-main)">${quizTotalCount}</strong> å€‹å–®å­—ã€‚
                </p>
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <label class="quiz-option-label" style="width:100%; max-width:320px;">
                        <input type="checkbox" name="qType" value="0" checked> 
                        <span>è‹±ç¿»ä¸­ (å–®å­— -> ä¸­æ–‡)</span>
                    </label>
                    <label class="quiz-option-label" style="width:100%; max-width:320px;">
                        <input type="checkbox" name="qType" value="1" checked> 
                        <span>ä¸­ç¿»è‹± (ä¸­æ–‡ -> æ‹¼å­—)</span>
                    </label>
                    <label class="quiz-option-label" style="width:100%; max-width:320px;">
                        <input type="checkbox" name="qType" value="2" checked> 
                        <span>å¡«ç©ºé¡Œ (å¥å­æŒ–ç©º)</span>
                    </label>
                    <label class="quiz-option-label" style="width:100%; max-width:320px;">
                        <input type="checkbox" name="qType" value="3" checked> 
                        <span>è½å¯«é¡Œ (è½éŸ³ -> æ‹¼å­—)</span>
                    </label>
                    <label class="quiz-option-label" style="width:100%; max-width:320px;">
                        <input type="checkbox" name="qType" value="4" checked> 
                        <span>è©æ€§é¡Œ (åˆ¤æ–·è©æ€§)</span>
                    </label>
                </div>
            </div>
            <button onclick="beginSession()" class="btn btn-primary" style="width:100%; margin-top:20px; font-size:1.1em; padding:12px;">ğŸš€ é–‹å§‹æ¸¬é©—</button>
        `;
        
        footerEl.innerHTML = '<button onclick="closeQuiz()" class="btn btn-secondary" style="width:100%;">å–æ¶ˆ</button>';
    }

    // 2. çœŸæ­£é–‹å§‹ (æŒ‰ä¸‹ã€Œé–‹å§‹æ¸¬é©—ã€å¾Œ)
    function beginSession() {
        // å–å¾—ä½¿ç”¨è€…å‹¾é¸çš„é¡Œå‹
        const checkboxes = document.querySelectorAll('input[name="qType"]:checked');
        selectedTypes = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (selectedTypes.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€ç¨®é¡Œå‹ï¼"); return; }

        document.getElementById('quiz-title').innerText = currentMode === 'review' ? "è¤‡ç¿’ä¸­..." : "ç·´ç¿’ä¸­...";
        document.getElementById('quiz-status').style.display = 'block'; // é¡¯ç¤ºè¨ˆæ™‚å™¨èˆ‡é€²åº¦
        
        // å•Ÿå‹•è¨ˆæ™‚å™¨
        quizStartTime = Date.now();
        if (quizTimerInterval) clearInterval(quizTimerInterval);
        
        quizTimerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - quizStartTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('quiz-timer').innerText = `${m}:${s}`;
        }, 1000);

        // æ¢å¾© footer
        document.getElementById('quiz-footer').innerHTML = '<button onclick="closeQuiz()" class="btn btn-secondary" style="width:100%;">ä¸­æ–·æ¸¬é©—</button>';

        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('quiz-feedback').innerHTML = '';
        
        // æ›´æ–°é€²åº¦é¡¯ç¤º (ä¾‹å¦‚: 4/10)
        // å› ç‚º pop() æœƒè®“ length è®Šå°ï¼Œæ‰€ä»¥ç”¨ (ç¸½æ•¸ - å‰©é¤˜æ•¸ + 1)
        const currentIdx = quizTotalCount - quizQueue.length + 1;
        document.getElementById('quiz-counter').innerText = `${Math.min(currentIdx, quizTotalCount)} / ${quizTotalCount}`;

        if (quizQueue.length === 0) {
            finishQuiz();
            return;
        }

        const card = quizQueue.pop(); // å–å‡ºä¸€å¼µå¡ç‰‡
        const def = card.definitions[Math.floor(Math.random() * card.definitions.length)];
        
        // å¾ä½¿ç”¨è€…å‹¾é¸çš„é¡Œå‹ä¸­éš¨æ©Ÿé¸ä¸€å€‹
        const type = selectedTypes[Math.floor(Math.random() * selectedTypes.length)];
        currentQ = { card, def, type }; 
        
        let html = '';
        // --- ç”¢ç”Ÿé¡Œç›® HTML (æ ¹æ“šé¡Œå‹) ---
        if (type === 0) { // è‹±ç¿»ä¸­
            setTimeout(() => speak(card.word), 300);
            html = `<h2 style="margin-bottom:10px;">${card.word}</h2>
                    <p style="color:var(--text-sub)">(${def.pos}) è«‹è¼¸å…¥ä¸­æ–‡æ„æ€</p>
                    <input type="text" id="ans-input" autocomplete="off" placeholder="ä¸­æ–‡å­—è©">`;
        } else if (type === 1) { // ä¸­ç¿»è‹±
            html = `<h2 style="margin-bottom:10px;">${def.meaning}</h2>
                    <p style="color:var(--text-sub)">(${def.pos}) è«‹æ‹¼å‡ºå–®å­—</p>
                    <input type="text" id="ans-input" autocomplete="off" placeholder="è‹±æ–‡æ‹¼å­—">`;
        } else if (type === 2) { // å¡«ç©º
            const masked = def.sentence ? def.sentence.replace(new RegExp(card.word, 'gi'), '_____') : null;
            if (masked) {
                html = `<div style="background:var(--input-bg); padding:15px; border-radius:8px; font-style:italic; margin-bottom:15px; text-align:left;">${masked}</div>
                        <p style="color:var(--text-sub)">(${def.pos}) ${def.meaning}</p>
                        <input type="text" id="ans-input" autocomplete="off" placeholder="å¡«å…¥ç¼ºå°‘çš„å–®å­—">`;
            } else {
                // å¦‚æœæ²’æœ‰ä¾‹å¥ï¼Œè‡ªå‹•é™ç´šç‚º Type 0
                currentQ.type = 0; 
                setTimeout(() => speak(card.word), 300);
                html = `<h2 style="margin-bottom:10px;">${card.word}</h2><p style="color:var(--text-sub)">(${def.pos}) è«‹è¼¸å…¥ä¸­æ–‡æ„æ€ (ç„¡ä¾‹å¥)</p><input type="text" id="ans-input" autocomplete="off">`;
            }
        } else if (type === 3) { // è½å¯«
            setTimeout(() => speak(card.word), 500);
            html = `<button class="big-speaker-btn" onclick="speak('${card.word}')">ğŸ”Š</button>
                    <p style="color:var(--text-sub)">è«‹è½ç™¼éŸ³ä¸¦æ‹¼å‡ºå–®å­—</p>
                    <input type="text" id="ans-input" autocomplete="off" placeholder="è½å¯«è‹±æ–‡">`;
        } else if (type === 4) { // è©æ€§
            setTimeout(() => speak(card.word), 300);
            html = `<h2 style="margin-bottom:5px;">${card.word}</h2>
                    <div style="font-size:1.2em; color:var(--warning); margin-bottom:15px;">ã€Œ${def.meaning}ã€</div>
                    <p style="color:var(--text-sub)">ç•¶ä½œé€™å€‹æ„æ€æ™‚ï¼Œå®ƒæ˜¯ä»€éº¼è©æ€§ï¼Ÿ</p>
                    <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px; font-size:12px; color:#64748b;">( n. / v. / adj. / adv. / prep. )</div>
                    <input type="text" id="ans-input" autocomplete="off" placeholder="è¼¸å…¥ç¸®å¯«">`;
        }

        html += `<button onclick="checkAns()" class="btn btn-primary" style="width:100%; margin-top:15px;">é€å‡ºç­”æ¡ˆ</button>`;
        document.getElementById('quiz-body').innerHTML = html;
        setTimeout(() => {
            const input = document.getElementById('ans-input');
            if(input) { input.focus(); input.onkeydown = (e) => { if(e.key==='Enter') checkAns(); }; }
        }, 100);
    }

    // --- ä¿®æ­£å¾Œçš„ç­”é¡Œæª¢æŸ¥é‚è¼¯ ---
    async function checkAns() {
        const inputEl = document.getElementById('ans-input');
        if (!inputEl) return;
        const input = inputEl.value.trim().toLowerCase();
        
        if (input === "") {
            alert("è«‹è¼¸å…¥ç­”æ¡ˆï¼ä¸èƒ½ç•™ç™½å–”ã€‚");
            inputEl.focus();
            return;
        }

        const card = currentQ.card;
        const def = currentQ.def;
        const type = currentQ.type;
        
        let isCorrect = false;
        let correctAnswerMsg = '';

        if (type === 0) { 
            isCorrect = input.length > 0 && def.meaning.includes(input);
            correctAnswerMsg = def.meaning;
        } else if (type === 1 || type === 2 || type === 3) { 
            isCorrect = (input === card.word.toLowerCase());
            correctAnswerMsg = card.word;
        } else if (type === 4) { 
            const standardInput = input.replace('.', '');
            const standardAns = def.pos.replace('.', '').toLowerCase();
            isCorrect = (standardInput === standardAns);
            correctAnswerMsg = def.pos;
        }

        const fb = document.getElementById('quiz-feedback');
        
        if (isCorrect) {
            fb.innerHTML = '<span style="color:var(--success)">âœ… Correct!</span>';
            if (currentMode === 'review') {
                if(card.level < 9) card.level++;
                card.nextReview = getTodayMidnight() + calculateNextInterval(card.level); 
                updateCardInBackend(card); 
            }
        } else {
            fb.innerHTML = `<span style="color:var(--danger)">âŒ Ans: <span style="font-weight:bold">${correctAnswerMsg}</span></span>`;
            if (type !== 0 && type !== 4) speak(card.word); 
            
            if (currentMode === 'review') {
                // ğŸ›‘ é—œéµä¿®æ­£ï¼šæœ€ä½ç­‰ç´šé™åˆ¶ç‚º 1
                // ç­”éŒ¯æ™‚ï¼šå¦‚æœç›®å‰æ˜¯ Lv2 -> è®Š Lv1ï¼›å¦‚æœç›®å‰æ˜¯ Lv1 -> ä¿æŒ Lv1
                card.level = Math.max(1, card.level - 1);
                
                // é‡æ–°è¨ˆç®—è¤‡ç¿’æ™‚é–“ (Level 1 æœƒå°æ‡‰åˆ° 1 å¤©å¾Œ)
                card.nextReview = getTodayMidnight() + calculateNextInterval(card.level); 
                
                updateCardInBackend(card); 
                quizQueue.unshift(card); 
            }
        }
        
        setTimeout(nextQuestion, 2000); 
    }

    function finishQuiz() {
        if (quizTimerInterval) clearInterval(quizTimerInterval);
        const duration = document.getElementById('quiz-timer').innerText;
        
        document.getElementById('quiz-body').innerHTML = `
            <h2 style="color:var(--success)">ğŸ‰ æ¸¬é©—å®Œæˆï¼</h2>
            <p style="font-size:1.2em;">è€—æ™‚ï¼š${duration}</p>
            <p style="color:var(--text-sub)">${currentMode === 'review' ? 'ç³»çµ±å·²æ›´æ–°è¨˜æ†¶æ›²ç·šã€‚' : 'æ‰‹æ„Ÿä¸éŒ¯ï¼ç¹¼çºŒä¿æŒã€‚'}</p>
        `;
        document.getElementById('quiz-footer').innerHTML = '<button onclick="closeQuiz()" class="btn btn-primary" style="width:100%;">çµæŸ</button>';
    }

    // ç¨ç«‹å‡ºä¾†çš„æ›´æ–°å‡½å¼
    async function updateCardInBackend(card) {
        try {
            await fetch(`${API_BASE_URL}/${card.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(card)
            });
        } catch(e) { console.error("SRS æ›´æ–°å¤±æ•—", e); }
    }

    function closeQuiz() { 
        if (quizTimerInterval) clearInterval(quizTimerInterval);
        document.getElementById('quiz-modal').style.display = 'none'; 
        if (currentMode === 'review') {
            loadWordsFromAPI(); // çµæŸå¾Œåˆ·æ–°ä¸»ç•«é¢
        }
    }

    // --- ä¸€éµæ¸…ç©ºè¡¨å–® ---
    function clearAddForm() {
        document.getElementById('input-word').value = ''; 
        document.getElementById('input-ipa').value = '';
        document.getElementById('definitions-container').innerHTML = ''; 
        addDefinitionInput('definitions-container'); 
    }

    
</script>
</body>

</html>





